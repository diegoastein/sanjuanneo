<!DOCTYPE html>
<html lang="es">
<head>
<link rel="icon" type="image/png" href="favicon-96x96.png" sizes="96x96" />
<link rel="icon" type="image/svg+xml" href="favicon.svg" />
<link rel="shortcut icon" href="favicon.ico" />
<link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png" />
<link rel="manifest" href="site.webmanifest" />
    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neonatología - Hospital Carrillo</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        /* Importar fuente Inter */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        /* Fuente general */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f9ff; /* bg-sky-50 */
            color: #111827; /* text-gray-900 */
        }

        /* Títulos */
        .title-text {
            color: #2563eb; 
        }

        /* Botones Generales */
        .btn-primary {
            background-color: #2563eb;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: bold;
            transition: background-color 0.3s;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border: none;
            cursor: pointer;
        }
        .btn-primary:hover {
            background-color: #1d4ed8;
        }

        .btn-secondary {
            background-color: #f3f4f6;
            color: #374151;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            border: 1px solid #d1d5db;
            transition: background-color 0.3s;
            cursor: pointer;
        }
        .btn-secondary:hover {
            background-color: #e5e7eb;
        }

        /* Botones de Acción en Tabla */
        .btn-danger {
            background-color: #dc2626;
            color: white;
            padding: 0.4rem 0.8rem;
            font-size: 0.8rem;
            border-radius: 0.375rem;
            font-weight: 600;
            transition: background-color 0.3s;
            border: none;
        }
        .btn-danger:hover { background-color: #b91c1c; }

        .btn-edit {
            background-color: #f97316;
            color: white;
            padding: 0.4rem 0.8rem;
            font-size: 0.8rem;
            border-radius: 0.375rem;
            font-weight: 600;
            transition: background-color 0.3s;
            border: none;
        }
        .btn-edit:hover { background-color: #ea580c; }

        .btn-share {
            background-color: #10b981; 
            color: white;
            padding: 0.4rem 0.8rem;
            font-size: 0.8rem;
            border-radius: 0.375rem;
            font-weight: 600;
            transition: background-color 0.3s;
            border: none;
        }
        .btn-share:hover { background-color: #059669; }

        /* Formularios */
        .form-input {
            width: 100%;
            padding: 0.6rem 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            transition: border-color 0.3s, box-shadow 0.3s;
            background-color: #fff;
        }
        .form-input:focus {
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
            outline: none;
        }

        /* Pestañas */
        .tab-btn {
            padding: 1rem 1.5rem;
            font-weight: 600;
            border-radius: 0.5rem 0.5rem 0 0;
            transition: background-color 0.3s, color 0.3s;
            border: none;
            cursor: pointer;
            outline: none;
        }
        .tab-btn.active {
            background-color: white;
            color: #2563eb;
            box-shadow: 0 -4px 6px -1px rgba(0, 0, 0, 0.05);
        }
        .tab-btn.inactive {
            background-color: transparent;
            color: #6b7280;
        }
        .tab-btn.inactive:hover {
            background-color: #e0f2fe; 
            color: #2563eb;
        }

        /* Scrollbars custom */
        #diag-modal-list::-webkit-scrollbar { width: 8px; }
        #diag-modal-list::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        #diag-modal-list::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        #diag-modal-list::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        /* Dashboard Card */
        .dash-card {
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            padding: 1.5rem;
            text-align: center;
        }
        .dash-card h4 { font-size: 0.875rem; color: #64748b; font-weight: 600; text-transform: uppercase; margin-bottom: 0.5rem; }
        .dash-card p { font-size: 2rem; font-weight: 700; color: #0f172a; }
    </style>
</head>
<body class="bg-sky-50 text-gray-900 min-h-screen flex flex-col">

    <header class="bg-blue-600 text-white shadow-lg p-4">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center gap-2">
                <h1 class="text-2xl font-bold tracking-tight">Neo Carrillo</h1>
            </div>
            <div class="flex items-center gap-4">
                <span id="user-id-display" class="text-sm font-medium bg-blue-700 px-3 py-1 rounded-full opacity-90">Conectando...</span>
            </div>
        </div>
    </header>

    <nav class="container mx-auto px-4 sm:px-8 mt-8">
        <div class="flex flex-wrap gap-x-2 border-b border-gray-200 bg-gray-100 rounded-t-lg p-2">
            <button id="tab-ingreso" class="tab-btn active w-full sm:w-auto text-center flex-1 sm:flex-none">
                Ingreso / Edición
            </button>
            <button id="tab-consulta" class="tab-btn inactive w-full sm:w-auto text-center flex-1 sm:flex-none">
                Consulta y Búsqueda
            </button>
            <button id="tab-dashboard" class="tab-btn inactive w-full sm:w-auto text-center flex-1 sm:flex-none">
                Dashboard
            </button>
        </div>
    </nav>

    <main class="container mx-auto px-4 sm:px-8 mb-12 flex-grow">

        <div id="ingreso-view" class="p-8 bg-white shadow-lg rounded-b-lg">
            <div class="flex justify-between items-center mb-6">
                <h2 id="form-title" class="text-2xl font-semibold title-text">Nuevo Ingreso</h2>
                <button type="button" id="btn-cancelar-edicion" class="hidden btn-secondary text-sm py-2">Cancelar Edición</button>
            </div>
            
            <form id="patient-form" class="space-y-6">
                
                <h3 class="text-lg font-semibold title-text border-b pb-2">Datos del Paciente</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="md:col-span-2">
                        <label for="nombre" class="block text-sm font-medium text-gray-700 mb-1">Nombre y Apellido</label>
                        <input type="text" id="nombre" name="nombre" class="form-input" required placeholder="Ingrese nombre completo">
                    </div>
                    
                    <div>
                        <label for="fechaNacimiento" class="block text-sm font-medium text-gray-700 mb-1">Fecha de Nacimiento</label>
                        <input type="date" id="fechaNacimiento" name="fechaNacimiento" class="form-input">
                    </div>
                    
                    <div>
                        <label for="procedencia" class="block text-sm font-medium text-gray-700 mb-1">Procedencia</label>
                        <select id="procedencia" name="procedencia" class="form-input">
                            <option value="">Seleccionar...</option>
                            <option value="Sala de partos">Sala de partos</option>
                            <option value="Quirófano">Quirófano</option>
                            <option value="Internación conjunta">Internación conjunta</option>
                            <option value="Derivado">Derivado</option>
                            <option value="Contrareferencia">Contrareferencia</option>
                            <option value="Guardia">Guardia</option>
                        </select>
                    </div>
                    
                    <div>
                        <label for="peso" class="block text-sm font-medium text-gray-700 mb-1">Peso al Nacer (gr)</label>
                        <input type="number" id="peso" name="peso" placeholder="Ej: 2500" class="form-input">
                    </div>

                    <div>
                        <label for="edadGestacional" class="block text-sm font-medium text-gray-700 mb-1">Edad Gestacional (sem)</label>
                        <input type="number" step="0.1" id="edadGestacional" name="edadGestacional" placeholder="Ej: 38.5" class="form-input">
                    </div>
                </div>
                
                <h3 class="text-lg font-semibold title-text border-b pb-2 pt-4">Datos de Internación</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div>
                        <label for="fechaInternacion" class="block text-sm font-medium text-gray-700 mb-1">F. Internación</label>
                        <input type="date" id="fechaInternacion" name="fechaInternacion" class="form-input">
                    </div>
                    <div>
                        <label for="fechaEgreso" class="block text-sm font-medium text-gray-700 mb-1">F. Egreso</label>
                        <input type="date" id="fechaEgreso" name="fechaEgreso" class="form-input">
                    </div>
                    <div>
                         <label for="statusEgreso" class="block text-sm font-medium text-gray-700 mb-1">Status Egreso</label>
                        <select id="statusEgreso" name="statusEgreso" class="form-input">
                            <option value="">(Sin egreso)</option>
                            <option value="Alta">Alta</option>
                            <option value="Derivación">Derivación</option>
                            <option value="Obito">Óbito</option>
                        </select>
                    </div>
                </div>
                
                <h3 class="text-lg font-semibold title-text border-b pb-2 pt-4">Diagnósticos</h3>
                <div>
                    <button type="button" id="btn-open-diag-modal" class="btn-secondary w-full sm:w-auto mb-3 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                        Seleccionar Diagnósticos
                    </button>
                    <div id="selected-diagnosticos-display" class="p-4 bg-gray-50 rounded-lg border border-gray-200 min-h-[60px] flex flex-wrap gap-2">
                        <p class="text-sm text-gray-500 w-full text-center py-2">Ningún diagnóstico seleccionado.</p>
                    </div>
                </div>

                <div class="pt-6 text-right border-t border-gray-100">
                    <button type="submit" id="btn-submit-form" class="btn-primary w-full sm:w-auto">
                        Guardar Paciente
                    </button>
                </div>
            </form>
        </div>

        <div id="consulta-view" class="hidden p-8 bg-white shadow-lg rounded-b-lg">
            
            <div class="bg-blue-50 p-6 rounded-lg border border-blue-100 mb-8">
                <h2 class="text-xl font-semibold title-text mb-4">Filtros de Búsqueda</h2>
                
                <div class="flex flex-col gap-4">
                    <!-- Fila 1: Texto, Patología, Procedencia -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-blue-600 uppercase mb-1">Nombre / Apellido</label>
                            <input type="text" id="search-general" placeholder="Buscar... (ej: Juan, Perez, Juan Pe...)" class="form-input">
                            <p class="text-xs text-blue-400 mt-1 ml-1">* Búsqueda instantánea en cualquier orden</p>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-blue-600 uppercase mb-1">Patología</label>
                            <select id="search-patologia" class="form-input">
                                <option value="">-- Todas --</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-blue-600 uppercase mb-1">Procedencia</label>
                            <select id="search-procedencia" class="form-input">
                                <option value="">-- Todas --</option>
                                <option value="Sala de partos">Sala de partos</option>
                                <option value="Quirófano">Quirófano</option>
                                <option value="Internación conjunta">Internación conjunta</option>
                                <option value="Derivado">Derivado</option>
                                <option value="Contrareferencia">Contrareferencia</option>
                                <option value="Guardia">Guardia</option>
                            </select>
                        </div>
                    </div>

                    <!-- Fila 2: Fechas y Edad Gestacional -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Nac. Desde</label>
                            <input type="date" id="search-date-start" class="form-input text-sm">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Nac. Hasta</label>
                            <input type="date" id="search-date-end" class="form-input text-sm">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">EG Min</label>
                            <input type="number" step="0.1" id="search-eg-start" placeholder="Sem" class="form-input text-sm">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">EG Max</label>
                            <input type="number" step="0.1" id="search-eg-end" placeholder="Sem" class="form-input text-sm">
                        </div>
                    </div>

                    <!-- Fila 3: Filtro Específico Internados -->
                    <div class="mt-2 border-t border-blue-200 pt-3 flex items-center">
                        <input id="search-only-interned" type="checkbox" class="w-5 h-5 text-blue-600 bg-white border-gray-300 rounded focus:ring-blue-500 focus:ring-2 cursor-pointer">
                        <label for="search-only-interned" class="ml-2 text-sm font-bold text-blue-800 cursor-pointer select-none flex items-center">
                            <svg class="w-4 h-4 mr-1 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path></svg>
                            Mostrar solo Pacientes Internados (Activos)
                        </label>
                    </div>
                </div>
            </div>

            <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
                <div class="text-sm font-medium text-gray-600" id="patient-count">
                    Cargando...
                </div>
                <div class="flex gap-2">
                    <button id="btn-export-filtered" class="btn-secondary py-2 px-3 text-sm">Exp. Vista</button>
                    <button id="btn-export-all" class="btn-secondary py-2 px-3 text-sm">Exp. Todo</button>
                    <button id="btn-nuevo-paciente" class="btn-primary py-2 px-3 text-sm flex items-center">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                        Nuevo
                    </button>
                </div>
            </div>

            <div class="md:hidden text-right mb-2 text-sm text-blue-600 italic animate-pulse">
                &larr; Desliza la tabla para ver acciones &rarr;
            </div>

            <div id="patient-list-container" class="overflow-hidden rounded-lg border border-gray-200">
                <div class="p-8 text-center text-gray-500">Iniciando base de datos...</div>
            </div>
        </div>

        <div id="dashboard-view" class="hidden p-8 bg-white shadow-lg rounded-b-lg">
            <div class="flex flex-col sm:flex-row justify-between items-center mb-8 gap-4 border-b border-gray-100 pb-4">
                <h2 class="text-2xl font-semibold title-text">Estadísticas</h2>
                
                <div class="flex gap-3 bg-gray-50 p-2 rounded-lg border border-gray-200">
                    <select id="dash-month" class="bg-white border border-gray-300 text-gray-700 text-sm rounded-md focus:ring-blue-500 focus:border-blue-500 block p-2">
                        <option value="0">Todo el Año</option>
                        <option value="1">Enero</option><option value="2">Febrero</option><option value="3">Marzo</option>
                        <option value="4">Abril</option><option value="5">Mayo</option><option value="6">Junio</option>
                        <option value="7">Julio</option><option value="8">Agosto</option><option value="9">Septiembre</option>
                        <option value="10">Octubre</option><option value="11">Noviembre</option><option value="12">Diciembre</option>
                    </select>
                    <select id="dash-year" class="bg-white border border-gray-300 text-gray-700 text-sm rounded-md focus:ring-blue-500 focus:border-blue-500 block p-2">
                        </select>
                </div>
            </div>

            <div id="dashboard-content" class="animate-fade-in">
                <div class="grid grid-cols-2 md:grid-cols-4 gap-6 mb-8">
                    <div class="dash-card bg-blue-50 border-blue-100">
                        <h4>Ingresos</h4>
                        <p id="stat-ingresos" class="text-blue-700">-</p>
                    </div>
                    <div class="dash-card">
                        <h4>Altas</h4>
                        <p id="stat-altas" class="text-green-600">-</p>
                    </div>
                    <div class="dash-card">
                        <h4>Derivaciones</h4>
                        <p id="stat-derivaciones" class="text-yellow-600">-</p>
                    </div>
                    <div class="dash-card">
                        <h4>Óbitos</h4>
                        <p id="stat-obitos" class="text-red-600">-</p>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    <div class="bg-white border border-gray-200 rounded-lg p-6 shadow-sm">
                        <h3 class="text-lg font-semibold text-gray-700 mb-4 flex items-center">
                            <svg class="w-5 h-5 mr-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 6l3 1m0 0l-3 9a5.002 5.002 0 006.001 0M6 7l3 9M6 7l6-2m6 2l3-1m-3 1l-3 9a5.002 5.002 0 006.001 0M18 7l3 9m-3-9l-6-2m0-2v2m0 16V5m0 16H9m3 0h3"></path></svg>
                            Promedios
                        </h3>
                        <div class="flex justify-around text-center">
                            <div>
                                <p class="text-sm text-gray-500 uppercase font-bold">Peso al Nacer</p>
                                <p id="stat-avg-peso" class="text-2xl font-bold text-gray-800 mt-1">-</p>
                                <span class="text-xs text-gray-400">gramos</span>
                            </div>
                            <div class="border-l border-gray-200 pl-8">
                                <p class="text-sm text-gray-500 uppercase font-bold">Edad Gestacional</p>
                                <p id="stat-avg-eg" class="text-2xl font-bold text-gray-800 mt-1">-</p>
                                <span class="text-xs text-gray-400">semanas</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white border border-gray-200 rounded-lg p-6 shadow-sm">
                        <h3 class="text-lg font-semibold text-gray-700 mb-4 flex items-center">
                            <svg class="w-5 h-5 mr-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 002 2h2a2 2 0 002-2z"></path></svg>
                            Top 5 Diagnósticos
                        </h3>
                        <ul id="stat-top-diag" class="space-y-2 text-sm text-gray-600">
                            <li class="italic text-gray-400">Cargando datos...</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <footer class="bg-white border-t border-gray-200 py-6 mt-auto">
        <div class="container mx-auto px-4 text-center text-gray-400 text-sm">
            &copy; 2025 Neonatología Hospital Carrillo - Sistema NeoManager
        </div>
    </footer>

    <div id="diagnostico-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 p-4 backdrop-blur-sm">
        <div class="bg-white rounded-lg shadow-2xl max-w-2xl w-full h-[80vh] flex flex-col transform transition-all">
            <div class="flex justify-between items-center p-5 border-b border-gray-100">
                <h3 class="text-xl font-bold text-gray-800">Seleccionar Diagnósticos</h3>
                <button id="btn-close-diag-modal" class="text-gray-400 hover:text-gray-600 text-2xl font-light">&times;</button>
            </div>
            
            <div class="p-5 flex-grow flex flex-col overflow-hidden">
                <div class="flex gap-2 mb-4">
                    <input type="text" id="diag-modal-search" placeholder="Buscar..." class="form-input flex-grow">
                </div>
                <div class="flex gap-2 mb-4 border-b border-gray-100 pb-4">
                    <input type="text" id="diag-modal-new-diag" placeholder="Nuevo diagnóstico..." class="form-input flex-grow text-sm">
                    <button id="btn-add-new-diag" class="btn-secondary py-1 px-3 text-xs uppercase tracking-wide">Agregar</button>
                </div>
                
                <div class="flex-grow overflow-y-auto pr-2">
                    <ul id="diag-modal-list" class="space-y-1">
                        </ul>
                </div>
            </div>
            
            <div class="p-5 border-t border-gray-100 bg-gray-50 text-right rounded-b-lg">
                <button id="btn-save-diag-modal" class="btn-primary">Confirmar Selección</button>
            </div>
        </div>
    </div>

    <div id="delete-modal" class="hidden fixed inset-0 bg-red-900 bg-opacity-20 flex items-center justify-center z-50 p-4 backdrop-blur-sm">
        <div class="bg-white rounded-lg shadow-xl max-w-sm w-full p-6 text-center">
            <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4">
                <svg class="h-6 w-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
            </div>
            <h3 class="text-lg font-medium text-gray-900">¿Borrar paciente?</h3>
            <p class="mt-2 text-sm text-gray-500">Se eliminará a <span id="delete-patient-name" class="font-bold"></span> permanentemente.</p>
            <div class="mt-5 flex justify-center gap-3">
                <button id="btn-cancel-delete" class="btn-secondary py-2 px-4">Cancelar</button>
                <button id="btn-confirm-delete" class="btn-danger py-2 px-4 text-sm">Sí, Borrar</button>
            </div>
        </div>
    </div>

    <div id="loading-overlay" class="hidden fixed inset-0 bg-white bg-opacity-80 flex items-center justify-center z-50 backdrop-blur-[2px]">
        <div class="flex flex-col items-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
            <p id="loading-message" class="text-blue-600 font-semibold mt-4">Procesando...</p>
        </div>
    </div>

    <div id="toast-notification" class="hidden fixed bottom-5 right-5 max-w-sm w-full bg-white border-l-4 p-4 rounded shadow-lg flex items-center transition-all duration-500 z-50 transform translate-y-10 opacity-0">
        <div class="flex-grow">
            <p id="toast-message" class="text-sm font-medium text-gray-800"></p>
        </div>
    </div>

    <script type="module">
        // Importar las funciones necesarias de Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            addDoc, 
            setDoc, 
            updateDoc, 
            deleteDoc, 
            onSnapshot,
            getDocs,
            getCountFromServer,
            collection, 
            query,
            where,
            orderBy,
            limit,
            setLogLevel
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- VARIABLES GLOBALES ---
        let app, auth, db, userId, appId;
        let pacientesCollectionRef, customDiagnosticosCollectionRef;

        // NUEVO: Cache local para búsqueda instantánea
        let allPatientsList = []; 
        let isPatientsLoaded = false;

        let filteredPacientes = []; 
        let totalPatientCount = 0; 
        let baseDiagnosticos = []; 
        let customDiagnosticos = []; 
        let allDiagnosticos = []; 

        let selectedDiagnosticos = []; 
        let editingPatientId = null; 
        let patientToDeleteId = null; 

        // Variable para la suscripción del Dashboard
        let unsubscribeDashboard = null;
        // Variable para la suscripción principal de datos
        let unsubscribePatients = null;

        // --- CONFIGURACIÓN DE FIREBASE ---
        let firebaseConfig;
        
        // Priorizar la configuración inyectada por el entorno si existe
        if (typeof __firebase_config !== 'undefined') {
            firebaseConfig = JSON.parse(__firebase_config);
        } else {
            // Configuración manual (fallback)
            firebaseConfig = {
                apiKey: "AIzaSyApnwRZQklxTBLhwBBIoyAcCiBAgzyhtvE",
                authDomain: "neomanager-a4482.firebaseapp.com",
                projectId: "neomanager-a4482",
                storageBucket: "neomanager-a4482.firebasestorage.app",
                messagingSenderId: "574188152831",
                appId: "1:574188152831:web:34ab797c5b709e7e3429ca"
            };
        }
        
        appId = typeof __app_id !== 'undefined' ? __app_id : 'neo-manager-default';

        // --- INICIALIZACIÓN DE LA APP ---

        document.addEventListener('DOMContentLoaded', () => {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            setLogLevel('Debug'); 

            populateBaseDiagnosticos();
            setupUIListeners();
            handleAuth();
        });

        // --- MANEJO DE AUTENTICACIÓN ---

        function handleAuth() {
            showLoading(true, "Conectando...");
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    console.log("Usuario autenticado:", userId);
                    const userDisplay = document.getElementById('user-id-display');
                    if(userDisplay) userDisplay.textContent = `ID: ${userId.substring(0,6)}...`;

                    const publicDataPath = `artifacts/${appId}/public/data`;
                    pacientesCollectionRef = collection(db, `${publicDataPath}/pacientes`);
                    customDiagnosticosCollectionRef = collection(db, `${publicDataPath}/diagnosticos_custom`);
                    
                    loadCustomDiagnosticos(); 
                    
                    // NUEVO: Iniciar escucha de datos principales (con límite seguro para rendimiento)
                    initDataListener();

                    // Inicializar Dashboard con fecha actual
                    initDashboard();

                    showLoading(false);
                    showView('ingreso-view'); 
                } else {
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        console.warn("Fallo autenticación con token, intentando anónimo...", error);
                        try {
                            await signInAnonymously(auth);
                        } catch (anonError) {
                            console.error("Error de autenticación final:", anonError);
                            showLoading(false);
                            showToast("Error de autenticación.", 'error');
                        }
                    }
                }
            });
        }

        // --- NUEVA LÓGICA DE DATOS: CACHÉ LOCAL ---
        
        function initDataListener() {
            // Escuchar los últimos 1000 pacientes para tener una base local rápida
            // Esto permite búsqueda instantánea, filtrado complejo y mejora UX.
            if (unsubscribePatients) unsubscribePatients();

            const q = query(
                pacientesCollectionRef, 
                orderBy("fechaInternacion", "desc"),
                limit(1000) // Límite de seguridad
            );

            unsubscribePatients = onSnapshot(q, (snapshot) => {
                allPatientsList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                isPatientsLoaded = true;
                totalPatientCount = allPatientsList.length; // Aproximado para la vista actual
                
                // Actualizar contador global si estamos en vista consulta
                if (!document.getElementById('consulta-view').classList.contains('hidden')) {
                    processLocalFilters();
                }
            }, (error) => {
                console.error("Error cargando pacientes:", error);
                showToast("Error de conexión a datos", "error");
            });
        }

        function loadCustomDiagnosticos() {
            onSnapshot(query(customDiagnosticosCollectionRef), (snapshot) => {
                customDiagnosticos = snapshot.docs.map(doc => doc.data().nombre).sort();
                updateAllDiagnosticosList();
            }, (error) => {
                console.error("Error al cargar diagnósticos custom:", error);
            });
        }

        // --- MANEJO DE UI ---

        function addListenerSafe(id, event, handler) {
            const el = document.getElementById(id);
            if (el) {
                el.addEventListener(event, handler);
            } else {
                console.warn(`Elemento UI no encontrado: ${id}`);
            }
        }

        function setupUIListeners() {
            // Pestañas
            addListenerSafe('tab-ingreso', 'click', () => showView('ingreso-view'));
            addListenerSafe('tab-consulta', 'click', () => {
                showView('consulta-view');
                processLocalFilters(); // Aplicar filtros al entrar
            });
            addListenerSafe('tab-dashboard', 'click', () => {
                showView('dashboard-view');
                updateDashboardStats(); 
            });

            // Botones
            addListenerSafe('btn-nuevo-paciente', 'click', () => {
                resetForm();
                showView('ingreso-view');
            });

            // Dashboard Selectors
            addListenerSafe('dash-month', 'change', updateDashboardStats);
            addListenerSafe('dash-year', 'change', updateDashboardStats);

            // Formularios
            addListenerSafe('patient-form', 'submit', handleFormSubmit);
            addListenerSafe('btn-cancelar-edicion', 'click', (e) => {
                e.preventDefault();
                resetForm();
                showView('consulta-view');
            });

            // Modales
            addListenerSafe('btn-open-diag-modal', 'click', () => showDiagnosticoModal(true));
            addListenerSafe('btn-close-diag-modal', 'click', () => showDiagnosticoModal(false));
            addListenerSafe('btn-save-diag-modal', 'click', saveDiagnosticosFromModal);
            addListenerSafe('diag-modal-search', 'input', renderDiagnosticoModalList);
            addListenerSafe('btn-add-new-diag', 'click', addNewDiagnostico);
            
            addListenerSafe('btn-cancel-delete', 'click', () => showDeleteModal(false));
            addListenerSafe('btn-confirm-delete', 'click', confirmDeletePatient);

            // Filtros - AHORA USAN processLocalFilters para velocidad
            addListenerSafe('search-general', 'input', processLocalFilters);
            addListenerSafe('search-date-start', 'change', processLocalFilters);
            addListenerSafe('search-date-end', 'change', processLocalFilters);
            addListenerSafe('search-eg-start', 'input', processLocalFilters);
            addListenerSafe('search-eg-end', 'input', processLocalFilters);
            addListenerSafe('search-patologia', 'change', processLocalFilters);
            addListenerSafe('search-procedencia', 'change', processLocalFilters);
            addListenerSafe('search-only-interned', 'change', processLocalFilters);

            // Exportar
            addListenerSafe('btn-export-filtered', 'click', () => exportToCsv(filteredPacientes, 'pacientes_neo_vista'));
            addListenerSafe('btn-export-all', 'click', handleExportAll); 
            
            // Acciones tabla
            addListenerSafe('patient-list-container', 'click', handlePatientListClick);
        }

        function showView(viewId) {
            const views = ['ingreso-view', 'consulta-view', 'dashboard-view'];
            const tabs = ['tab-ingreso', 'tab-consulta', 'tab-dashboard'];

            // Scroll to top when switching views
            window.scrollTo({ top: 0, behavior: 'smooth' });

            views.forEach((v, idx) => {
                const el = document.getElementById(v);
                const tab = document.getElementById(tabs[idx]);
                
                if (el) {
                    if (v === viewId) {
                        el.classList.remove('hidden');
                    } else {
                        el.classList.add('hidden');
                    }
                }
                
                if (tab) {
                    if (v === viewId) {
                        tab.classList.add('active');
                        tab.classList.remove('inactive');
                    } else {
                        tab.classList.remove('active');
                        tab.classList.add('inactive');
                    }
                }
            });
        }

        function showLoading(show, message = "Cargando...") {
            const overlay = document.getElementById('loading-overlay');
            const messageEl = document.getElementById('loading-message');
            if (show) {
                if(messageEl) messageEl.textContent = message;
                overlay.classList.remove('hidden');
            } else {
                overlay.classList.add('hidden');
            }
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast-notification');
            const toastMessage = document.getElementById('toast-message');
            
            toastMessage.textContent = message;
            
            toast.className = "fixed bottom-5 right-5 max-w-sm w-full bg-white border-l-4 p-4 rounded shadow-lg flex items-center transition-all duration-500 z-50 transform";
            
            if (type === 'success') {
                toast.classList.add('border-green-500');
                toastMessage.classList.add('text-green-700');
            } else if (type === 'error') {
                toast.classList.add('border-red-500');
                toastMessage.classList.add('text-red-700');
            } else {
                toast.classList.add('border-yellow-500');
                toastMessage.classList.add('text-yellow-700');
            }
            
            toast.classList.remove('hidden', 'translate-y-10', 'opacity-0');
            
            setTimeout(() => {
                toast.classList.add('translate-y-10', 'opacity-0');
                setTimeout(() => toast.classList.add('hidden'), 500);
            }, 3000);
        }

        // --- LOGICA DASHBOARD ---

        function initDashboard() {
            const now = new Date();
            const currentYear = now.getFullYear();
            const currentMonth = now.getMonth() + 1; // JS months are 0-indexed

            // Llenar selector de años (Actual - 2 hasta Actual + 2)
            const yearSelect = document.getElementById('dash-year');
            yearSelect.innerHTML = '';
            for (let y = currentYear - 2; y <= currentYear + 2; y++) {
                const opt = document.createElement('option');
                opt.value = y;
                opt.textContent = y;
                if (y === currentYear) opt.selected = true;
                yearSelect.appendChild(opt);
            }

            // Setear mes actual
            document.getElementById('dash-month').value = currentMonth;

            // Iniciar listener
            updateDashboardStats();
        }

        function updateDashboardStats() {
            const month = parseInt(document.getElementById('dash-month').value);
            const year = parseInt(document.getElementById('dash-year').value);

            let startStr, endStr;

            if (month === 0) {
                // Año Completo
                startStr = `${year}-01-01`;
                endStr = `${year}-12-31`;
            } else {
                // Mes Específico
                startStr = `${year}-${String(month).padStart(2, '0')}-01`;
                const lastDay = new Date(year, month, 0).getDate();
                endStr = `${year}-${String(month).padStart(2, '0')}-${lastDay}`;
            }

            // Cancelar suscripción anterior si existe
            if (unsubscribeDashboard) {
                unsubscribeDashboard();
            }

            // Usar 'fechaInternacion' como criterio principal para "Ingresos del periodo"
            const q = query(
                pacientesCollectionRef, 
                where("fechaInternacion", ">=", startStr),
                where("fechaInternacion", "<=", endStr)
            );

            unsubscribeDashboard = onSnapshot(q, (snapshot) => {
                const pacientes = snapshot.docs.map(doc => doc.data());
                calculateAndRenderStats(pacientes);
            }, (error) => {
                console.error("Error en Dashboard:", error);
            });
        }

        function calculateAndRenderStats(pacientes) {
            // 1. Contadores Básicos
            const total = pacientes.length;
            const altas = pacientes.filter(p => p.statusEgreso === 'Alta').length;
            const obitos = pacientes.filter(p => p.statusEgreso === 'Obito').length;
            const derivaciones = pacientes.filter(p => p.statusEgreso === 'Derivación').length;

            document.getElementById('stat-ingresos').textContent = total;
            document.getElementById('stat-altas').textContent = altas;
            document.getElementById('stat-obitos').textContent = obitos;
            document.getElementById('stat-derivaciones').textContent = derivaciones;

            // 2. Promedios (Peso y EG)
            let sumPeso = 0;
            let countPeso = 0;
            let sumEG = 0;
            let countEG = 0;
            let allDiags = [];

            pacientes.forEach(p => {
                if (p.peso && !isNaN(p.peso)) {
                    sumPeso += Number(p.peso);
                    countPeso++;
                }
                if (p.edadGestacional && !isNaN(p.edadGestacional)) {
                    sumEG += Number(p.edadGestacional);
                    countEG++;
                }
                if (Array.isArray(p.diagnosticos)) {
                    allDiags.push(...p.diagnosticos);
                }
            });

            const avgPeso = countPeso > 0 ? Math.round(sumPeso / countPeso) : '-';
            const avgEG = countEG > 0 ? (sumEG / countEG).toFixed(1) : '-';

            document.getElementById('stat-avg-peso').textContent = avgPeso;
            document.getElementById('stat-avg-eg').textContent = avgEG;

            // 3. Top 5 Diagnósticos
            const diagCounts = {};
            allDiags.forEach(d => {
                diagCounts[d] = (diagCounts[d] || 0) + 1;
            });

            // Convertir a array, ordenar y tomar top 5
            const sortedDiags = Object.entries(diagCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);

            const listEl = document.getElementById('stat-top-diag');
            listEl.innerHTML = '';
            
            if (sortedDiags.length === 0) {
                listEl.innerHTML = '<li class="italic text-gray-400">Sin datos registrados</li>';
            } else {
                sortedDiags.forEach(([name, count]) => {
                    const li = document.createElement('li');
                    li.className = "flex justify-between items-center border-b border-gray-100 pb-1 last:border-0";
                    li.innerHTML = `
                        <span class="truncate pr-2">${name}</span>
                        <span class="bg-blue-100 text-blue-800 text-xs font-semibold px-2 py-0.5 rounded-full">${count}</span>
                    `;
                    listEl.appendChild(li);
                });
            }
        }

        // --- LOGICA MODALES Y FORMULARIOS ---

        function showDiagnosticoModal(show) {
            const modal = document.getElementById('diagnostico-modal');
            if (show) {
                renderDiagnosticoModalList();
                modal.classList.remove('hidden');
            } else {
                document.getElementById('diag-modal-search').value = '';
                modal.classList.add('hidden');
            }
        }

        function showDeleteModal(show, patientName = '') {
            const modal = document.getElementById('delete-modal');
            if (show) {
                document.getElementById('delete-patient-name').textContent = patientName;
                modal.classList.remove('hidden');
            } else {
                modal.classList.add('hidden');
                patientToDeleteId = null;
            }
        }

        async function handleFormSubmit(e) {
            e.preventDefault();
            showLoading(true, "Guardando...");

            const form = e.target;
            
            const nombreOriginal = form.nombre.value;
            // Generamos keywords para búsqueda futura si volvemos a búsqueda server-side
            const keywords = nombreOriginal.toLowerCase().split(' ').filter(kw => kw.length > 0);

            const patientData = {
                nombre: nombreOriginal,
                nombre_keywords: keywords, 
                fechaNacimiento: form.fechaNacimiento.value,
                peso: form.peso.valueAsNumber,
                edadGestacional: form.edadGestacional.valueAsNumber,
                procedencia: form.procedencia.value,
                fechaInternacion: form.fechaInternacion.value,
                fechaEgreso: form.fechaEgreso.value,
                statusEgreso: form.statusEgreso.value,
                diagnosticos: selectedDiagnosticos,
                lastUpdatedBy: userId,
                lastUpdatedAt: new Date().toISOString()
            };

            try {
                if (editingPatientId) {
                    const patientRef = doc(db, `artifacts/${appId}/public/data/pacientes`, editingPatientId);
                    await updateDoc(patientRef, patientData);
                    showToast("Paciente actualizado", "success");
                } else {
                    patientData.createdAt = new Date().toISOString(); 
                    patientData.createdBy = userId;
                    await addDoc(pacientesCollectionRef, patientData);
                    // No necesitamos llamar updateTotalPatientCount porque el listener onSnapshot lo hará
                    showToast("Paciente ingresado", "success");
                }
                
                resetForm();
                showView('consulta-view');
                // processLocalFilters se ejecutará automáticamente por el listener onSnapshot
                
            } catch (error) {
                console.error("Error al guardar:", error);
                showToast("Error al guardar.", "error");
            } finally {
                showLoading(false);
            }
        }

        function resetForm() {
            document.getElementById('patient-form').reset();
            editingPatientId = null;
            selectedDiagnosticos = [];
            updateSelectedDiagnosticosDisplay();
            document.getElementById('form-title').textContent = "Nuevo Ingreso";
            document.getElementById('btn-submit-form').textContent = "Guardar Paciente";
            document.getElementById('btn-cancelar-edicion').classList.add('hidden');
        }

        function handlePatientListClick(e) {
            const button = e.target.closest('button');
            if (!button) return;
            
            // Prevent default button behavior just in case
            e.preventDefault();

            const action = button.dataset.action;
            const id = button.dataset.id;
            const name = button.dataset.name;

            if (action === 'edit') {
                const patient = filteredPacientes.find(p => p.id === id);
                if (patient) {
                    const form = document.getElementById('patient-form');
                    if(form) {
                        form.nombre.value = patient.nombre || '';
                        form.fechaNacimiento.value = patient.fechaNacimiento || '';
                        // Use '' instead of null for safety
                        form.peso.value = patient.peso || '';
                        form.edadGestacional.value = patient.edadGestacional || '';
                        form.procedencia.value = patient.procedencia || '';
                        form.fechaInternacion.value = patient.fechaInternacion || '';
                        form.fechaEgreso.value = patient.fechaEgreso || '';
                        form.statusEgreso.value = patient.statusEgreso || '';
                        
                        selectedDiagnosticos = Array.isArray(patient.diagnosticos) ? [...patient.diagnosticos] : [];
                        updateSelectedDiagnosticosDisplay();
                        
                        editingPatientId = patient.id;
                        const titleEl = document.getElementById('form-title');
                        if(titleEl) titleEl.textContent = "Editando Paciente";
                        
                        const btnSubmit = document.getElementById('btn-submit-form');
                        if(btnSubmit) btnSubmit.textContent = "Actualizar Datos";
                        
                        const btnCancel = document.getElementById('btn-cancelar-edicion');
                        if(btnCancel) btnCancel.classList.remove('hidden');
                        
                        showView('ingreso-view');
                    }
                } else {
                    console.error("Paciente no encontrado en memoria local:", id);
                    showToast("Error al cargar datos del paciente", "error");
                }
            } else if (action === 'delete') {
                patientToDeleteId = id;
                showDeleteModal(true, name);
            } else if (action === 'share') { 
                const patient = filteredPacientes.find(p => p.id === id);
                if (patient) sharePatientSummary(patient);
            }
        }

        function sharePatientSummary(patient) {
            const summary = `
*FICHA NEONATOLOGÍA*
👤 *${patient.nombre || 'N/A'}*
📅 Nac: ${patient.fechaNacimiento || 'N/A'}
⚖️ Peso: ${patient.peso ? `${patient.peso}gr` : 'N/A'} | EG: ${patient.edadGestacional ? `${patient.edadGestacional}sem` : 'N/A'}
🏥 Procedencia: ${patient.procedencia || 'N/A'}
🏷️ Status: ${patient.statusEgreso || 'Internado'}

📋 *Diagnósticos:*
${Array.isArray(patient.diagnosticos) && patient.diagnosticos.length > 0 ? patient.diagnosticos.join(', ') : 'S/D'}
`;
            
            navigator.clipboard.writeText(summary).then(() => {
                showToast("Ficha copiada al portapapeles", 'success');
            }).catch(err => {
                // Fallback
                const textarea = document.createElement('textarea');
                textarea.value = summary;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                showToast("Ficha copiada", 'success');
            });
        }

        async function confirmDeletePatient() {
            if (!patientToDeleteId) return;
            
            showLoading(true, "Borrando...");
            try {
                const patientRef = doc(db, `artifacts/${appId}/public/data/pacientes`, patientToDeleteId);
                await deleteDoc(patientRef);
                // onSnapshot se encarga de actualizar la UI
                showToast("Paciente eliminado", "success");
            } catch (error) {
                console.error("Error al borrar:", error);
                showToast("Error al eliminar.", "error");
            } finally {
                showDeleteModal(false);
                showLoading(false);
            }
        }

        function updateAllDiagnosticosList() {
            allDiagnosticos = [...baseDiagnosticos, ...customDiagnosticos].sort();
            
            const selectPatologia = document.getElementById('search-patologia');
            const currentValue = selectPatologia.value; 
            
            selectPatologia.innerHTML = '<option value="">-- Todas las Patologías --</option>';
            
            allDiagnosticos.forEach(diag => {
                const option = document.createElement('option');
                option.value = diag;
                option.textContent = diag;
                selectPatologia.appendChild(option);
            });
            
            selectPatologia.value = currentValue;
        }

        function renderDiagnosticoModalList() {
            const listContainer = document.getElementById('diag-modal-list');
            const filter = document.getElementById('diag-modal-search').value.toLowerCase();
            
            listContainer.innerHTML = '';
            
            const diagnosToShow = allDiagnosticos.filter(d => d.toLowerCase().includes(filter));
            
            if (diagnosToShow.length === 0) {
                listContainer.innerHTML = '<p class="text-sm text-gray-400 italic p-2">No se encontraron resultados.</p>';
                return;
            }

            diagnosToShow.forEach(diag => {
                const isChecked = selectedDiagnosticos.includes(diag);
                const li = document.createElement('li');
                li.classList.add('flex', 'items-center', 'p-2', 'hover:bg-gray-50', 'rounded', 'cursor-pointer');
                li.innerHTML = `
                    <label class="flex items-center w-full cursor-pointer">
                        <input type="checkbox" 
                            class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" 
                            data-diag-name="${diag}" 
                            ${isChecked ? 'checked' : ''}>
                        <span class="ml-3 text-sm text-gray-700">${diag}</span>
                    </label>
                `;
                
                li.querySelector('input').addEventListener('change', (e) => {
                    const name = e.target.dataset.diagName;
                    if (e.target.checked) {
                        if (!selectedDiagnosticos.includes(name)) selectedDiagnosticos.push(name);
                    } else {
                        selectedDiagnosticos = selectedDiagnosticos.filter(d => d !== name);
                    }
                });
                
                listContainer.appendChild(li);
            });
        }

        function saveDiagnosticosFromModal() {
            updateSelectedDiagnosticosDisplay();
            showDiagnosticoModal(false);
        }

        function updateSelectedDiagnosticosDisplay() {
            const container = document.getElementById('selected-diagnosticos-display');
            if (selectedDiagnosticos.length === 0) {
                container.innerHTML = '<p class="text-sm text-gray-500 w-full text-center py-2">Ningún diagnóstico seleccionado.</p>';
            } else {
                container.innerHTML = selectedDiagnosticos
                    .map(d => `<span class="inline-flex items-center bg-blue-50 text-blue-700 text-xs font-semibold mr-2 mb-2 px-2.5 py-1 rounded border border-blue-100">${d}</span>`)
                    .join('');
            }
        }

        async function addNewDiagnostico() {
            const input = document.getElementById('diag-modal-new-diag');
            const newDiagName = input.value.trim();
            
            if (!newDiagName) return;
            
            if (allDiagnosticos.some(d => d.toLowerCase() === newDiagName.toLowerCase())) {
                showToast("Ya existe ese diagnóstico", "warn");
                return;
            }
            
            try {
                await addDoc(customDiagnosticosCollectionRef, { nombre: newDiagName });
                input.value = '';
                if (!selectedDiagnosticos.includes(newDiagName)) selectedDiagnosticos.push(newDiagName);
                renderDiagnosticoModalList();
            } catch (error) {
                console.error("Error agregando diagnóstico:", error);
            }
        }

        // --- NUEVA LÓGICA DE FILTRADO (CLIENT-SIDE) ---

        function processLocalFilters() {
            if (!isPatientsLoaded) return;

            const searchInput = document.getElementById('search-general');
            const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
            
            const dateStart = document.getElementById('search-date-start').value;
            const dateEnd = document.getElementById('search-date-end').value;
            const egStart = parseFloat(document.getElementById('search-eg-start').value);
            const egEnd = parseFloat(document.getElementById('search-eg-end').value);
            const patologiaFilter = document.getElementById('search-patologia').value;
            const procedenciaFilter = document.getElementById('search-procedencia').value;
            const onlyInternedEl = document.getElementById('search-only-interned');
            const onlyInterned = onlyInternedEl ? onlyInternedEl.checked : false;

            const hasFilters = (searchTerm && searchTerm.trim() !== '') || dateStart || dateEnd || !isNaN(egStart) || !isNaN(egEnd) || patologiaFilter || procedenciaFilter || onlyInterned;

            // Filtrado en memoria: Rápido y Flexible
            filteredPacientes = allPatientsList.filter(p => {
                // 1. Filtro Internados (Activos)
                if (onlyInterned && p.statusEgreso !== '') return false;
                
                // 2. Filtro Procedencia
                if (procedenciaFilter && p.procedencia !== procedenciaFilter) return false;
                
                // 3. Filtro Patología (array contains)
                if (patologiaFilter) {
                    if (!p.diagnosticos || !p.diagnosticos.includes(patologiaFilter)) return false;
                }
                
                // 4. Fechas
                if (dateStart && (!p.fechaNacimiento || p.fechaNacimiento < dateStart)) return false;
                if (dateEnd && (!p.fechaNacimiento || p.fechaNacimiento > dateEnd)) return false;

                // 5. Edad Gestacional
                const eg = p.edadGestacional;
                if (!isNaN(egStart) && (eg === undefined || eg < egStart)) return false;
                if (!isNaN(egEnd) && (eg === undefined || eg > egEnd)) return false;

                // 6. NOMBRE: Búsqueda parcial y flexible ("juan per" encuentra "Perez Juan")
                if (searchTerm) {
                    const name = (p.nombre || '').toLowerCase();
                    // Dividimos lo que escribe el usuario por espacios
                    const searchTerms = searchTerm.split(' ').filter(t => t.length > 0);
                    // Verificamos que TODAS las palabras escritas estén en el nombre
                    const matchesAll = searchTerms.every(term => name.includes(term));
                    if (!matchesAll) return false;
                }

                return true;
            });

            if (!hasFilters) {
                // Si no hay filtros, mostramos solo los últimos 3 (asumiendo orden descendente por defecto)
                renderPatientList(filteredPacientes.slice(0, 3), false);
            } else {
                renderPatientList(filteredPacientes, true);
            }
        }

        function renderPatientList(pacientes, isFiltered) {
            const listContainer = document.getElementById('patient-list-container');
            const counterEl = document.getElementById('patient-count');
            
            if (!listContainer || !counterEl) return;
            const total = totalPatientCount || 0;

            if (isFiltered) {
                counterEl.innerHTML = `Base de datos: <b>${total}</b> (recientes) | Resultado: <b>${pacientes.length}</b>`;
            } else {
                counterEl.innerHTML = `Total Cargados: <b>${total}</b> (Mostrando últimos ${pacientes.length})`;
            }
            
            if ((!pacientes || pacientes.length === 0)) {
                listContainer.innerHTML = '<div class="p-8 text-center text-gray-400 bg-gray-50">No se encontraron pacientes que coincidan con la búsqueda.</div>';
                return;
            }
            
            listContainer.innerHTML = `
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Paciente</th>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Detalles</th>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Status</th>
                                <th class="px-6 py-3 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider">Acciones</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-100">
                            ${pacientes.map(p => `
                                <tr class="hover:bg-blue-50 transition-colors">
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="text-sm font-bold text-gray-900">${p.nombre}</div>
                                        <div class="text-xs text-gray-500">${p.fechaNacimiento || '--/--/----'}</div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="text-xs text-gray-700"><span class="font-semibold">Peso:</span> ${p.peso ? p.peso + 'g' : '-'}</div>
                                        <div class="text-xs text-gray-700"><span class="font-semibold">EG:</span> ${p.edadGestacional ? p.edadGestacional + 's' : '-'}</div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${
                                            p.statusEgreso === 'Alta' ? 'bg-green-100 text-green-800' :
                                            p.statusEgreso === 'Derivación' ? 'bg-yellow-100 text-yellow-800' :
                                            p.statusEgreso === 'Obito' ? 'bg-red-100 text-red-800' : 'bg-blue-100 text-blue-800'
                                        }">
                                            ${p.statusEgreso || 'Internado'}
                                        </span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                        <div class="flex justify-end gap-2">
                                            <button data-action="share" data-id="${p.id}" data-name="${p.nombre}" class="btn-share shadow-sm">
                                                Compartir
                                            </button>
                                            <button data-action="edit" data-id="${p.id}" data-name="${p.nombre}" class="btn-edit shadow-sm">
                                                Editar
                                            </button>
                                            <button data-action="delete" data-id="${p.id}" data-name="${p.nombre}" class="btn-danger shadow-sm">
                                                Borrar
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function exportToCsv(dataToExport, filename) {
            if (!dataToExport || dataToExport.length === 0) {
                showToast("No hay datos para exportar", "warn");
                return;
            }
            const headers = ["ID", "Nombre", "F.Nac", "Peso", "EG", "Procedencia", "F.Int", "F.Egr", "Status", "Diagnosticos"];
            const csvRows = [headers.join(',')];

            dataToExport.forEach(p => {
                const escape = (val) => {
                    if (val === undefined || val === null) return '';
                    let str = String(val);
                    if (str.includes(',') || str.includes('"') || str.includes('\n')) str = `"${str.replace(/"/g, '""')}"`;
                    return str;
                };
                const diagStr = Array.isArray(p.diagnosticos) ? p.diagnosticos.join('; ') : '';
                const values = [p.id, p.nombre, p.fechaNacimiento, p.peso, p.edadGestacional, p.procedencia, p.fechaInternacion, p.fechaEgreso, p.statusEgreso, diagStr].map(escape);
                csvRows.push(values.join(','));
            });

            const blob = new Blob([csvRows.join('\n')], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `${filename}.csv`;
            link.click();
        }

        async function handleExportAll() {
            showLoading(true, "Exportando Todo...");
            try {
                // Si tenemos la data en memoria y no supera el límite de 1000, podemos usarla
                // Pero para "Export Todo" siempre es mejor asegurar un fetch fresco completo si es crítico
                // Para este caso, usamos getDocs para asegurar TODA la base de datos histórica
                const snapshot = await getDocs(query(pacientesCollectionRef, orderBy('createdAt', 'desc')));
                const all = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                exportToCsv(all, 'pacientes_neo_total_db');
            } catch (error) {
                console.error(error);
                showToast("Error al exportar todo", "error");
            } finally {
                showLoading(false);
            }
        }

        function populateBaseDiagnosticos() {
            baseDiagnosticos = [
                "Taquipnea Transitoria del Recién Nacido (TTRN)", "Síndrome de Dificultad Respiratoria (SDR)", "Síndrome de Aspiración de Líquido Amniótico Meconial (SALAM)",
                "Hipertensión Pulmonar Persistente del Recién Nacido (HPPRN)", "Neumonía Neonatal Precoz", "Neumonía Neonatal Tardía", "Displasia Broncopulmonar (DBP)",
                "Apnea del Prematuro", "Neumotórax", "Hernia Diafragmática Congénita", "Atresia de Coanas", "Enfisema Lobar Congénito", "Malformación Adenomatosa Quística Pulmonar",
                "Hiperbilirrubinemia Neonatal", "Hipoglucemia Neonatal", "Hipocalcemia Neonatal", "Hipotermia Neonatal", "Inestabilidad Térmica", "Anemia del Prematuro",
                "Policitemia Neonatal", "Enfermedad Hemorrágica del Recién Nacido", "Trombocitopenia Neonatal Inmune", "Trombocitopenia Neonatal No Inmune",
                "Trastornos de la Coagulación Neonatal", "Hiponatremia", "Hipernatremia", "Hipomagnesemia", "Sospecha de Error Innato del Metabolismo",
                "Sospecha de Sepsis Neonatal Precoz", "Sepsis Neonatal Precoz Confirmada", "Sospecha de Sepsis Neonatal Tardía", "Sepsis Neonatal Tardía Confirmada",
                "Meningitis Neonatal", "Infección por Citomegalovirus (CMV) Congénito", "Infección por Herpes Simple (HSV) Neonatal", "Sífilis Congénita",
                "Toxoplasmosis Congénita", "Conjuntivitis Neonatal Química", "Conjuntivitis Neonatal Gonocócica", "Conjuntivitis Neonatal por Clamidia", "Onfalitis",
                "Candidiasis Sistémica Neonatal", "Infección del Tracto Urinario (ITU) Neonatal", "Encefalopatía Hipóxico-Isquémica (EHI)", "Convulsiones Neonatales",
                "Hemorragia Intraventricular Grado I", "Hemorragia Intraventricular Grado II", "Hemorragia Intraventricular Grado III", "Hemorragia Intraventricular Grado IV",
                "Leucomalacia Periventricular (LPV)", "Hidrocefalia Congénita", "Hidrocefalia Adquirida", "Mielomeningocele", "Microcefalia", "Macrocefalia",
                "Síndrome de Abstinencia Neonatal (SAN)", "Hemorragia Subdural Neonatal", "Hemorragia Subaracnoidea Neonatal", "Hipotonía Neonatal",
                "Parálisis Braquial Obstétrica", "Parálisis Facial Neonatal", "Ductus Arterioso Persistente (PCA)", "Comunicación Interauricular (CIA)",
                "Comunicación Interventricular (CIV)", "Coartación de Aorta (CoA)", "Tetralogía de Fallot", "Transposición de Grandes Vasos (TGV)",
                "Síndrome de Corazón Izquierdo Hipoplásico", "Canal Auriculoventricular", "Estenosis Pulmonar Crítica", "Estenosis Aórtica Crítica", "Shock Séptico Neonatal",
                "Shock Cardiogénico Neonatal", "Shock Hipovolémico Neonatal", "Taquicardia Supraventricular Neonatal", "Sospecha de Enterocolitis Necrotizante",
                "Enterocolitis Necrotizante Confirmada", "Reflujo Gastroesofágico (RGE) Neonatal", "Dificultades de Alimentación", "Intolerancia Alimentaria",
                "Atresia Esofágica", "Fístula Traqueoesofágica", "Atresia Duodenal", "Estenosis Duodenal", "Atresia Yeyuno-ileal", "Malrotación Intestinal",
                "Vólvulo Intestinal", "Enfermedad de Hirschsprung", "Íleo Meconial", "Ano Imperforado", "Gastrosquisis", "Onfalocele", "Diarrea Neonatal Infecciosa",
                "Diarrea Neonatal Metabólica", "Deshidratación Neonatal",
                "Prematurez", // Diagnóstico consolidado
                "Restricción del Crecimiento Intrauterino (RCIU)", "Pequeño para la Edad Gestacional (PEG)", "Retinopatía del Prematuro (ROP) Estadio 1",
                "Retinopatía del Prematuro (ROP) Estadio 2", "Retinopatía del Prematuro (ROP) Estadio 3", "Retinopatía del Prematuro (ROP) Estadio 4",
                "Retinopatía del Prematuro (ROP) Estadio 5", "Osteopenia del Prematuro", "Hipoacusia Neonatal", "Bajo Peso al Nacer (BPN)", "Muy Bajo Peso al Nacer (MBPN)",
                "Extremado Bajo Peso al Nacer (EBPN)", "Insuficiencia Renal Aguda (IRA) Neonatal", "Hidronefrosis Neonatal", "Reflujo Vesicoureteral",
                "Válvulas de Uretra Posterior", "Extrofia Vesical", "Hipospadias", "Epispadias", "Trastorno del Desarrollo Sexual (Genitales Ambiguos)",
                "Riñón Multiquístico Displásico", "Displasia del Desarrollo de la Cadera (DDC)", "Fisura Labiopalatina", "Síndrome de Down (Trisomía 21)",
                "Síndrome de Edwards (Trisomía 18)", "Síndrome de Patau (Trisomía 13)", "Síndrome de Turner", "Pie Equinovaro (Pie Zambo)", "Cefalohematoma",
                "Caput Succedaneum", "Fractura de Clavícula Obstétrica", "Linfangioma / Higroma Quístico", "Hemangioma Infantil", "Hiperplasia Suprarrenal Congénita",
                "Hipotiroidismo Congénito"
            ];
            baseDiagnosticos.sort();
        }
    </script>
</body>
</html>
